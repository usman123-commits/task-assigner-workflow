{
  "name": "PHASE 2 – Cleaner Assignment + Calendar Dispatch",
  "nodes": [
    {
      "parameters": {},
      "id": "aea175e9-f19d-45f2-b523-d932663529cf",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        -3088,
        560
      ],
      "notes": "Replace with Schedule Trigger (e.g. every 5 min) for production. Kept Manual for testing."
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "12q_ZZJEkE6xQGJH0XxwCFlt821lpEBgCjLkfm0GmX-g",
          "mode": "list",
          "cachedResultName": "hostfully",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/12q_ZZJEkE6xQGJH0XxwCFlt821lpEBgCjLkfm0GmX-g/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "CleanersProfile",
          "mode": "name"
        },
        "options": {}
      },
      "id": "4f98f423-2d6f-427f-9c0d-617082da0ea7",
      "name": "Read CleanersProfile",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.4,
      "position": [
        -2864,
        560
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "6WzYJIrG1pOhcusY",
          "name": "Google Sheets account"
        }
      },
      "notes": "Tab: CleanersProfile. Columns: property UID, cleaner ID, calendar ID, email, name, contact. Used by Assign Cleaner for lookup."
    },
    {
      "parameters": {
        "jsCode": "// Pass one item so Read Pending Cleaning Jobs runs once (CleanersProfile data is available via $('Read CleanersProfile').all() later).\nreturn [$input.first()];"
      },
      "id": "90f2ab2e-c2ec-4e6e-be3b-406f991a03bb",
      "name": "Single Item for Read Jobs",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2640,
        560
      ],
      "notes": "Outputs one item so downstream Read Pending Cleaning Jobs runs once. CleanersProfile rows are read once and referenced in Assign Cleaner."
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "12q_ZZJEkE6xQGJH0XxwCFlt821lpEBgCjLkfm0GmX-g",
          "mode": "list",
          "cachedResultName": "hostfully",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/12q_ZZJEkE6xQGJH0XxwCFlt821lpEBgCjLkfm0GmX-g/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "CleaningJobs",
          "mode": "name"
        },
        "options": {}
      },
      "id": "006e0492-1232-4ea9-a837-a20a8a75d3c7",
      "name": "Read Pending Cleaning Jobs",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.4,
      "position": [
        -2416,
        560
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "6WzYJIrG1pOhcusY",
          "name": "Google Sheets account"
        }
      },
      "notes": "Same spreadsheet as Phase 1. Sheet: CleaningJobs. Reads all rows; Filter Pending Only filters by status=PENDING and empty cleanerId."
    },
    {
      "parameters": {
        "jsCode": "// CleaningJobs sheet has 'status' (not cleaningStatus). Keep only PENDING, no cleaner assigned, no event yet, processingFlag empty (row-level lock).\nconst items = $input.all();\nconst filtered = items.filter(item => {\n  const j = item.json || {};\n  const status = (j.status ?? '').toString().trim();\n  const cleanerId = (j.cleanerId ?? '').toString().trim();\n  const hasEvent = (j.calendarEventId ?? '').toString().trim() !== '';\n  const processingFlag = (j.processingFlag ?? '').toString().trim();\n  return status === 'PENDING' && cleanerId === '' && !hasEvent && processingFlag === '';\n});\nreturn filtered;"
      },
      "id": "bf424ca2-3bdc-4a40-9f8a-98c16ec3282a",
      "name": "Filter Pending Only",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2192,
        560
      ],
      "notes": "Ensures we only process PENDING + empty cleanerId. Skips if calendarEventId already set (no duplicate events)."
    },
    {
      "parameters": {
        "jsCode": "// Attach CleanersProfile data to each job so Assign Cleaner can use it inside the loop (no $('Read CleanersProfile') in loop).\nlet profile = [];\ntry {\n  const node = $('Read CleanersProfile');\n  if (node && typeof node.all === 'function') profile = node.all();\n} catch (_) {}\nconst items = $input.all();\nreturn items.map(item => ({ json: { ...item.json, _cleanersProfile: Array.isArray(profile) ? profile : [] } }));"
      },
      "id": "fbbbf048-7a3c-40e1-83dc-2362704fcb58",
      "name": "Attach CleanersProfile",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1968,
        560
      ],
      "notes": "Runs once before loop. Attaches CleanersProfile rows to each item so Assign Cleaner can read them inside the loop."
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "11f57d98-9d83-4668-ad1c-41f17f7f25f8",
      "name": "Split In Batches",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -1744,
        560
      ],
      "notes": "Process one cleaning job at a time to avoid overwrites and allow clear error scope."
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "12q_ZZJEkE6xQGJH0XxwCFlt821lpEBgCjLkfm0GmX-g",
          "mode": "list",
          "cachedResultName": "hostfully",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/12q_ZZJEkE6xQGJH0XxwCFlt821lpEBgCjLkfm0GmX-g/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "Reservations",
          "mode": "name"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "bookingUid",
              "lookupValue": "={{ $json.bookingUid }}"
            }
          ]
        },
        "options": {}
      },
      "id": "c007c9cf-a9f9-478f-bac4-1e17f7e71a0e",
      "name": "Lookup Reservation",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.4,
      "position": [
        -1296,
        320
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "6WzYJIrG1pOhcusY",
          "name": "Google Sheets account"
        }
      },
      "notes": "Same spreadsheet as Phase 1. Sheet: Reservations. Enriches with propertyName, address if columns exist."
    },
    {
      "parameters": {
        "jsCode": "// If Lookup returned 0 rows or empty row, use job only with fallbacks. Otherwise use first lookup row.\n// propertyName: use reservation lookup first; else get from CleanersProfile row matching propertyUid (column may be 'propertyName ' with space); else fallback to propertyUid.\nconst job = $('Split In Batches').last().json;\nconst items = $input.all();\nconst hasReservation = items.length > 0 && items[0].json?.bookingUid;\nconst lookup = hasReservation ? items[0].json : {};\nlet propertyName = (lookup.propertyName ?? '').toString().trim();\nif (!propertyName && Array.isArray(job._cleanersProfile)) {\n  const pu = (job.propertyUid ?? '').toString().trim();\n  const profileRow = job._cleanersProfile.find(r => {\n    const j = r?.json ?? r;\n    const uid = (j?.propertyUid ?? j?.['property UID'] ?? '').toString().trim();\n    return uid && uid === pu;\n  });\n  if (profileRow) {\n    const j = profileRow?.json ?? profileRow;\n    propertyName = (j?.['propertyName '] ?? j?.propertyName ?? '').toString().trim();\n  }\n}\nif (!propertyName) propertyName = (job.propertyUid ?? '').toString().trim();\nconst merged = { ...job, ...lookup, propertyName, address: lookup.address ?? job.address ?? 'Address TBD' };\nreturn [{ json: merged }];"
      },
      "id": "6839ac62-3399-4b3e-be55-2c3944eaf314",
      "name": "Ensure One Item (Job or Reservation)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1072,
        320
      ],
      "notes": "When Lookup returns no row, pass job only with propertyName/address fallbacks so Assign Cleaner still runs."
    },
    {
      "parameters": {
        "jsCode": "// Merge cleaning job (from Split In Batches) with reservation (from Ensure One Item).\nconst job = $('Split In Batches').last().json;\nconst lookup = $input.first().json;\nconst merged = { ...job, ...lookup };\nreturn [{ json: merged }];"
      },
      "id": "aad24698-0b64-4629-ad2d-0016c24bd398",
      "name": "Merge Job and Reservation",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -848,
        320
      ],
      "notes": "One item: cleaning job + reservation fields for propertyName, address, etc."
    },
    {
      "parameters": {
        "jsCode": "// STEP 2 — Assign cleaner by propertyUid using CleanersProfile data attached before the loop. Columns: property UID, cleaner ID, calendar ID, email, name, contact.\nconst item = $input.first().json;\nconst propertyUid = (item.propertyUid ?? '').toString().trim();\nconst rows = Array.isArray(item._cleanersProfile) ? item._cleanersProfile : [];\nif (rows.length === 0) throw new Error('No CleanersProfile data on item. Ensure Attach CleanersProfile node runs before Split In Batches and Read CleanersProfile has rows.');\nconst get = (row, ...keys) => { const j = row && (row.json !== undefined ? row.json : row); if (!j || typeof j !== 'object') return ''; for (const k of keys) { const v = j[k]; if (v !== undefined && v !== null && String(v).trim() !== '') return String(v).trim(); } return ''; };\nconst mapping = rows.find(r => {\n  const uid = get(r, 'property UID', 'propertyUid');\n  return uid && uid === propertyUid;\n});\nif (!mapping) {\n  throw new Error(`No cleaner for propertyUid: ${propertyUid}. Add a row in CleanersProfile with property UID = ${propertyUid}.`);\n}\nconst cleanerId = get(mapping, 'cleaner ID', 'cleanerId');\nconst email = get(mapping, 'email');\nconst calendarId = get(mapping, 'calendar ID', 'calendarId');\nif (!cleanerId) throw new Error(`CleanersProfile row for ${propertyUid} has no cleaner ID.`);\nconst assignedAt = new Date().toISOString();\nconst propertyNameFromProfile = get(mapping, 'propertyName ', 'propertyName');\nconst out = { ...item, cleanerId, cleanerEmail: email || item.cleanerEmail, cleanerCalendarId: calendarId || item.cleanerCalendarId, cleanerName: get(mapping, 'name'), cleanerContact: get(mapping, 'contact'), assignedAt, status: 'ASSIGNED', propertyName: propertyNameFromProfile || item.propertyName || item.propertyUid };\ndelete out._cleanersProfile;\nreturn [{ json: out }];"
      },
      "id": "54b637fe-f29e-438e-9412-f6e9c372b506",
      "name": "Assign Cleaner",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -624,
        320
      ],
      "notes": "Lookup from CleanersProfile sheet by property UID. Needs columns: property UID, cleaner ID, calendar ID, email, name, contact."
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "12q_ZZJEkE6xQGJH0XxwCFlt821lpEBgCjLkfm0GmX-g",
          "mode": "list",
          "cachedResultName": "hostfully",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/12q_ZZJEkE6xQGJH0XxwCFlt821lpEBgCjLkfm0GmX-g/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "CleaningJobs",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "bookingUid": "={{ $json.bookingUid }}",
            "cleanerId": "={{ $json.cleanerId }}",
            "assignedAt": "={{ $json.assignedAt }}"
          },
          "matchingColumns": [
            "bookingUid"
          ],
          "schema": [
            {
              "id": "cleaningJobId",
              "displayName": "cleaningJobId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "bookingUid",
              "displayName": "bookingUid",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "propertyUid",
              "displayName": "propertyUid",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "cleaningDate",
              "displayName": "cleaningDate",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "cleaningTime",
              "displayName": "cleaningTime",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "assignedCleaner",
              "displayName": "assignedCleaner",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "clockIn",
              "displayName": "clockIn",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "clockOut",
              "displayName": "clockOut",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "workedHours",
              "displayName": "workedHours",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "createdAtSystem",
              "displayName": "createdAtSystem",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "cleanerId",
              "displayName": "cleanerId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "assignedAt",
              "displayName": "assignedAt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "notificationStatus",
              "displayName": "notificationStatus",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "calendarStatus",
              "displayName": "calendarStatus",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "calendarEventId",
              "displayName": "calendarEventId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "calendarId",
              "displayName": "calendarId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "processingFlag",
              "displayName": "processingFlag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "e9f590c4-3e5c-476c-a253-d6a467c6aab8",
      "name": "Update Job Assigned",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.4,
      "position": [
        -400,
        320
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "6WzYJIrG1pOhcusY",
          "name": "Google Sheets account"
        }
      },
      "notes": "Update by bookingUid. Sets cleanerId and assignedAt only. status=ASSIGNED is written later by Finalize Assignment after calendar creation."
    },
    {
      "parameters": {
        "jsCode": "// STEP 3 — Calculate cleaning time: start 11:00 AM on cleaningDate, duration 3 hours.\nconst DURATION_HOURS = 3;\nconst item = $input.first().json;\nconst cleaningDateRaw = item.cleaningDate || item.checkOut || '';\nlet startTime;\ntry {\n  const d = new Date(cleaningDateRaw);\n  if (isNaN(d.getTime())) throw new Error('Invalid date');\n  d.setHours(11, 0, 0, 0);\n  startTime = d.toISOString();\n} catch (_) {\n  startTime = new Date().toISOString().replace(/T\\d{2}:\\d{2}:\\d{2}/, 'T11:00:00');\n}\nconst endDate = new Date(startTime);\nendDate.setHours(endDate.getHours() + DURATION_HOURS);\nconst endTime = endDate.toISOString();\nreturn [{ json: { ...item, startTime, endTime, durationHours: DURATION_HOURS } }];"
      },
      "id": "61abba55-877c-47be-8fa3-012b9bab2ad6",
      "name": "Calculate Cleaning Time",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -176,
        320
      ],
      "notes": "startTime = cleaningDate at 11:00 AM; endTime = startTime + 3h. Change DURATION_HOURS to make configurable."
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "has-event",
              "leftValue": "={{ ($json.calendarEventId ?? '').toString().trim() }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "d2052567-1f79-45b1-9078-ba042b1aef24",
      "name": "Already Has Calendar Event?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        48,
        320
      ],
      "notes": "TRUE = calendarEventId set → skip event creation (and notification). FALSE = create events + notify."
    },
    {
      "parameters": {
        "calendar": {
          "__rl": true,
          "value": "usman2acountf@gmail.com",
          "mode": "list",
          "cachedResultName": "usman2acountf@gmail.com"
        },
        "start": "={{ $json.startTime }}",
        "end": "={{ $json.endTime }}",
        "additionalFields": {}
      },
      "id": "9a252572-5b1c-411a-9ee6-ee1e59e19052",
      "name": "Create Admin Calendar Event",
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1.2,
      "position": [
        272,
        224
      ],
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "u0zJ9RMcwZ9KgjoO",
          "name": "Google Calendar account"
        }
      },
      "notes": "Primary/admin calendar. Set calendarId in parameters (e.g. primary or shared admin calendar)."
    },
    {
      "parameters": {
        "calendar": {
          "__rl": true,
          "value": "={{ $('Assign Cleaner').item.json.cleanerEmail }}",
          "mode": "id"
        },
        "start": "={{ $('Calculate Cleaning Time').item.json.startTime }}",
        "end": "={{ $('Calculate Cleaning Time').item.json.endTime }}",
        "additionalFields": {}
      },
      "id": "400f91f7-71d5-4482-9a2a-b190426679fb",
      "name": "Create Cleaner Calendar Event",
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1.2,
      "position": [
        496,
        224
      ],
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "u0zJ9RMcwZ9KgjoO",
          "name": "Google Calendar account"
        }
      },
      "notes": "Cleaner's calendar. Event ID from response is saved to sheet in next node."
    },
    {
      "parameters": {
        "jsCode": "// Pass through job + calendar event id from cleaner event (for sheet update).\nconst job = $('Calculate Cleaning Time').last().json;\nconst eventResult = $input.first().json;\nconst eventId = eventResult?.id ?? eventResult?.data?.id ?? '';\nreturn [{ json: { ...job, calendarEventId: eventId } }];"
      },
      "id": "ba6422fb-ef23-4bd3-9b8f-3e649447bdec",
      "name": "Prepare Event Id for Sheet",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        720,
        224
      ],
      "notes": "Extracts event ID from Google Calendar create response. Cleaner calendar event ID is source of truth for link."
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "12q_ZZJEkE6xQGJH0XxwCFlt821lpEBgCjLkfm0GmX-g",
          "mode": "list",
          "cachedResultName": "hostfully",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/12q_ZZJEkE6xQGJH0XxwCFlt821lpEBgCjLkfm0GmX-g/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "CleaningJobs",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "bookingUid": "={{ $json.bookingUid }}",
            "calendarEventId": "={{ $json.calendarEventId }}",
            "row_number": 0
          },
          "matchingColumns": [
            "bookingUid"
          ],
          "schema": [
            {
              "id": "cleaningJobId",
              "displayName": "cleaningJobId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "bookingUid",
              "displayName": "bookingUid",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "propertyUid",
              "displayName": "propertyUid",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "cleaningDate",
              "displayName": "cleaningDate",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "cleaningTime",
              "displayName": "cleaningTime",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "assignedCleaner",
              "displayName": "assignedCleaner",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "clockIn",
              "displayName": "clockIn",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "clockOut",
              "displayName": "clockOut",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "workedHours",
              "displayName": "workedHours",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "createdAtSystem",
              "displayName": "createdAtSystem",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "cleanerId",
              "displayName": "cleanerId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "assignedAt",
              "displayName": "assignedAt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "notificationStatus",
              "displayName": "notificationStatus",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "calendarStatus",
              "displayName": "calendarStatus",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "calendarEventId",
              "displayName": "calendarEventId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "calendarId",
              "displayName": "calendarId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "processingFlag",
              "displayName": "processingFlag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "d0efa183-2b1c-478e-92b5-a962b5ecde41",
      "name": "Update Job With Event Id",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.4,
      "position": [
        944,
        224
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "6WzYJIrG1pOhcusY",
          "name": "Google Sheets account"
        }
      },
      "notes": "Same spreadsheet as Phase 1. Sheet: CleaningJobs. Writes calendarEventId by bookingUid."
    },
    {
      "parameters": {
        "sendTo": "={{ $('Assign Cleaner').item.json.cleanerEmail }}",
        "subject": "=New Cleaning Assigned – {{ $('Assign Cleaner').item.json.propertyName || $('Assign Cleaner').item.json.propertyUid }}",
        "emailType": "text",
        "message": "=You have been assigned a new cleaning job.\n\nProperty: {{ $('Assign Cleaner').item.json.propertyName || $('Assign Cleaner').item.json.propertyUid }}\nAddress: {{ $('Calculate Cleaning Time').last().json.address || 'Not provided' }}\nDate: {{ DateTime.fromISO( $('Calculate Cleaning Time').item.json.startTime).toFormat('yyyy-MM-dd HH:mm:ss') }}\n\nTime: {{ DateTime.fromISO($('Calculate Cleaning Time').item.json.startTime).toFormat('HH:mm') }}\nGuest Count: {{ $('Assign Cleaner').item.json.adultCount + $('Assign Cleaner').item.json.childrenCount }}\nBooking Reference: {{ $('Calculate Cleaning Time').last().json.bookingUid }}\n\nCalendar Event:\n{{ $json.calendarEventId ? 'https://calendar.google.com/calendar/event?eid=' + encodeURIComponent($json.calendarEventId) : 'Event created – check your calendar' }}\n\nThis email serves as official assignment confirmation.",
        "options": {}
      },
      "id": "835ddfb5-81cc-47cc-b326-32af6ae8734f",
      "name": "Send Gmail to Cleaner",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        1168,
        224
      ],
      "webhookId": "1a9edaf5-05fc-43a5-b167-dae117a87bc1",
      "credentials": {
        "gmailOAuth2": {
          "id": "gBew8I7wXjZj6cXO",
          "name": "Gmail account"
        }
      },
      "notes": "Sends to cleaner email from mapping. Calendar link uses event ID (format may vary by API)."
    },
    {
      "parameters": {},
      "id": "f5156b81-4626-4229-b92a-8e74c3331cd0",
      "name": "Skip (Already Has Event)",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        272,
        416
      ],
      "notes": "When calendarEventId already set: no duplicate event, no duplicate email. Rejoin loop."
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "12q_ZZJEkE6xQGJH0XxwCFlt821lpEBgCjLkfm0GmX-g",
          "mode": "list",
          "cachedResultName": "hostfully",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/12q_ZZJEkE6xQGJH0XxwCFlt821lpEBgCjLkfm0GmX-g/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "CleaningJobs",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "bookingUid": "={{ $json.bookingUid }}",
            "processingFlag": "LOCKED"
          },
          "matchingColumns": [
            "bookingUid"
          ],
          "schema": [
            {
              "id": "bookingUid",
              "displayName": "bookingUid",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "processingFlag",
              "displayName": "processingFlag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "7519a69c-e6d3-4222-a32c-1a434fc852ae",
      "name": "Lock Cleaning Job",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.4,
      "position": [
        -1520,
        320
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "6WzYJIrG1pOhcusY",
          "name": "Google Sheets account"
        }
      },
      "notes": "Row-level lock: set processingFlag=LOCKED so other runs do not pick this row. Runs before Assign Cleaner."
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "12q_ZZJEkE6xQGJH0XxwCFlt821lpEBgCjLkfm0GmX-g",
          "mode": "list",
          "cachedResultName": "hostfully",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/12q_ZZJEkE6xQGJH0XxwCFlt821lpEBgCjLkfm0GmX-g/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "CleaningJobs",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "bookingUid": "={{ $('Update Job With Event Id').item.json.bookingUid }}",
            "cleanerId": "={{ $('Prepare Event Id for Sheet').item.json.cleanerId }}",
            "assignedAt": "={{ $('Prepare Event Id for Sheet').item.json.assignedAt }}",
            "status": "ASSIGNED",
            "calendarStatus": "CREATED",
            "calendarEventId": "={{ $('Update Job With Event Id').item.json.calendarEventId }}",
            "calendarId": "={{ $json.cleanerCalendarId ?? '' }}"
          },
          "matchingColumns": [
            "bookingUid"
          ],
          "schema": [
            {
              "id": "bookingUid",
              "displayName": "bookingUid",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "cleanerId",
              "displayName": "cleanerId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "assignedAt",
              "displayName": "assignedAt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "calendarStatus",
              "displayName": "calendarStatus",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "calendarEventId",
              "displayName": "calendarEventId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "calendarId",
              "displayName": "calendarId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "processingFlag",
              "displayName": "processingFlag",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "a4b01863-57bb-46f5-941f-9f893ccb6664",
      "name": "Finalize Assignment",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.4,
      "position": [
        1392,
        392
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "6WzYJIrG1pOhcusY",
          "name": "Google Sheets account"
        }
      },
      "notes": "Atomic update after calendar creation and Gmail: sets status=ASSIGNED, calendarStatus=CREATED, clears processingFlag."
    }
  ],
  "pinData": {},
  "connections": {
    "Manual Trigger": {
      "main": [
        [
          {
            "node": "Read CleanersProfile",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read CleanersProfile": {
      "main": [
        [
          {
            "node": "Single Item for Read Jobs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Single Item for Read Jobs": {
      "main": [
        [
          {
            "node": "Read Pending Cleaning Jobs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read Pending Cleaning Jobs": {
      "main": [
        [
          {
            "node": "Filter Pending Only",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter Pending Only": {
      "main": [
        [
          {
            "node": "Attach CleanersProfile",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Attach CleanersProfile": {
      "main": [
        [
          {
            "node": "Split In Batches",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split In Batches": {
      "main": [
        [],
        [
          {
            "node": "Lock Cleaning Job",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Lock Cleaning Job": {
      "main": [
        [
          {
            "node": "Lookup Reservation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Lookup Reservation": {
      "main": [
        [
          {
            "node": "Ensure One Item (Job or Reservation)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ensure One Item (Job or Reservation)": {
      "main": [
        [
          {
            "node": "Merge Job and Reservation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Job and Reservation": {
      "main": [
        [
          {
            "node": "Assign Cleaner",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Assign Cleaner": {
      "main": [
        [
          {
            "node": "Update Job Assigned",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Job Assigned": {
      "main": [
        [
          {
            "node": "Calculate Cleaning Time",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calculate Cleaning Time": {
      "main": [
        [
          {
            "node": "Already Has Calendar Event?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Already Has Calendar Event?": {
      "main": [
        [
          {
            "node": "Skip (Already Has Event)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Create Admin Calendar Event",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Skip (Already Has Event)": {
      "main": [
        [
          {
            "node": "Split In Batches",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Admin Calendar Event": {
      "main": [
        [
          {
            "node": "Create Cleaner Calendar Event",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Cleaner Calendar Event": {
      "main": [
        [
          {
            "node": "Prepare Event Id for Sheet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Event Id for Sheet": {
      "main": [
        [
          {
            "node": "Update Job With Event Id",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Job With Event Id": {
      "main": [
        [
          {
            "node": "Send Gmail to Cleaner",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Gmail to Cleaner": {
      "main": [
        [
          {
            "node": "Finalize Assignment",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Finalize Assignment": {
      "main": [
        [
          {
            "node": "Split In Batches",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "binaryMode": "separate",
    "availableInMCP": false
  },
  "versionId": "9a6855b0-9002-41c5-afc5-79c7f5091aad",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "0bb07b5703ea134861899ac05e6415d78b46918890ccb5152413bbf5502ab3aa"
  },
  "id": "9vDem5tE8Vz67m2x",
  "tags": []
}